# 🚀 ReviAI - AI評審作業システム 開発計画書

---

## 📋 プロジェクト概要

**ReviAI**は、プログラム基本設計書のAI評審プロセスを自動化するシステムです。ExcelからPDFを生成し、Gemini 2.5 Pro APIを使用して文書を評価し、結果をフォーマット済みExcelファイルとして出力します。

---

## 🎯 システム要件

### 機能要件
1. **第1段階**: ExcelファイルからPDFを生成
   - ユーザーがExcelファイルを選択
   - 対象シートを複数選択可能
   - バージョン番号を指定
   - A4横向きPDFとして出力（FitToPagesWide=1）

2. **第2段階**: Gemini 2.5 ProによるAI評審
   - PDFファイルをGemini APIにアップロード
   - カスタマイズ可能な評審プロンプトを使用
   - 構造化された8列の表データを抽出
   - 日本語テキストの完全サポート

3. **第3段階**: 評審結果のExcel保存
   - AI出力を解析してExcelに書き込み
   - 淡い青色のヘッダー行
   - AutoFilter有効化
   - 全セルに罫線
   - 列幅の自動調整

### 非機能要件
- **GUI**: PySide6を使用した3ステップウィザード形式
- **ログ**: すべての操作を`logs/app.log`に記録
- **構成**: `config.ini`でAPI keyとプロンプトを管理
- **エラーハンドリング**: ユーザーフレンドリーなエラーメッセージ
- **スレッド処理**: API呼び出し中もUIがフリーズしない

---

## 📦 技術スタック

| コンポーネント | 技術 | バージョン | 用途 |
|--------------|------|----------|------|
| **言語** | Python | 3.8+ | プログラミング言語 |
| **GUI** | PySide6 | 6.6.0+ | グラフィカルユーザーインターフェース |
| **Excel→PDF** | xlwings | 0.30.0+ | ExcelからPDF生成（COM API使用） |
| **AI API** | google-genai | 1.0.0+ | Gemini 2.5 Pro APIクライアント |
| **データ検証** | Pydantic | 2.0.0+ | 構造化出力のスキーマ定義 |
| **Excel出力** | openpyxl | 3.1.0+ | フォーマット済みExcel生成 |
| **構成管理** | configparser | 標準ライブラリ | config.ini管理 |

---

## 📁 プロジェクト構造

```
ReviAI/
├── config.ini                    # API key、モデル設定
├── prompt_template.txt           # 評審プロンプトテンプレート（編集可能）
├── requirements.txt              # Python依存関係
├── 開発計画.md                   # 本ドキュメント
├── AI評審作業_フロー.md          # 業務フロー仕様書
│
├── logs/
│   └── app.log                   # アプリケーションログ
│
├── output/
│   ├── pdfs/                     # 生成されたPDFファイル
│   └── results/                  # 評審結果Excelファイル
│
└── src/
    ├── __init__.py               # Pythonパッケージ初期化
    ├── main.py                   # PySide6 GUIメインアプリケーション
    ├── models.py                 # Pydanticデータモデル（ReviewRow, ReviewTable）
    ├── logger.py                 # ログユーティリティ
    ├── config_manager.py         # 構成ファイル管理
    ├── step1_excel_to_pdf.py    # 第1段階: Excel→PDF変換
    ├── step2_ai_review.py       # 第2段階: Gemini AI評審
    └── step3_save_results.py    # 第3段階: Excel結果保存
```

---

## 🔧 セットアップ手順

### 1. 前提条件
- **Python 3.8以降**がインストールされていること
- **Microsoft Excel**がインストールされていること（xlwings依存）
- **Gemini API key**を取得済み（[https://aistudio.google.com/apikey](https://aistudio.google.com/apikey)）
- インターネット接続（API呼び出し用）

### 2. 依存関係のインストール
```bash
cd d:\ReviAI
pip install -r requirements.txt
```

インストールされるパッケージ:
- PySide6 (約150-200MB)
- xlwings
- google-genai
- openpyxl
- pydantic
- python-dotenv

### 3. 構成ファイルの編集

**config.ini**を開いて、Gemini API keyを設定:
```ini
[API]
gemini_api_key = あなたのAPIキーをここに貼り付け
gemini_model = gemini-2.5-pro

[Paths]
default_output_dir = ./output

[Settings]
temperature = 0
max_output_tokens = 8192
max_retries = 3
```

### 4. プロンプトのカスタマイズ（オプション）

**prompt_template.txt**を編集して、評審基準をカスタマイズできます。デフォルトのプロンプトは日本語で、8列の構造化出力を要求します。

---

## 🎮 使用方法

### アプリケーションの起動

```bash
cd d:\ReviAI\src
python main.py
```

### ワークフロー

#### **第1段階: Excel→PDF生成**
1. **「ファイルを選択」**ボタンをクリックしてExcelファイルを選択
2. 自動的にすべてのシート名が表示されます
3. PDF化したい**シートをチェック**（複数選択可能）
4. **バージョン番号**を入力（例: 6）
5. **「PDF生成」**ボタンをクリック
6. 生成結果が表示されます:
   - `{ファイル名}_{シート名}_V{バージョン}.pdf`
7. **「次へ」**をクリックして第2段階へ

#### **第2段階: AI評審**
1. 第1段階で生成されたPDFファイルが自動的に表示されます
2. **「プロンプトを確認/編集」**ボタンで評審基準を確認・編集（オプション）
3. **「AI評審開始」**ボタンをクリック
4. 進行状況バーが表示されます（処理時間: 約30秒〜2分）
5. 評審完了後、抽出された行数とプレビューが表示されます
6. **「次へ」**をクリックして第3段階へ

#### **第3段階: 結果保存**
1. **回数**を入力（例: 6 → 「第六回.xlsx」）
2. 必要に応じて**出力先**を変更
3. **「Excelに保存」**ボタンをクリック
4. 保存成功メッセージと保存先パスが表示されます

---

## 🧩 モジュール詳細

### models.py
**Pydanticデータモデル**を定義:
- `ReviewRow`: 評審結果の1行（8つのフィールド）
- `ReviewTable`: 評審結果の表全体（Rowのリスト）

これらのモデルは、Gemini APIから返されるJSON構造を強制し、自動検証します。

### logger.py
**ログシステム**:
- ファイルとコンソールの両方に出力
- フォーマット: `[2025-01-27 14:30:45] [INFO] メッセージ`
- ログファイル: `logs/app.log`

### config_manager.py
**構成管理クラス**:
- `load_config()`: config.iniから設定を読み込み
- `save_config()`: config.iniに設定を保存
- `validate_api_key()`: API keyの有効性をチェック
- `get_prompt_template()`: プロンプトテンプレートを読み込み
- `save_prompt_template()`: プロンプトテンプレートを保存

### step1_excel_to_pdf.py
**Excel→PDF変換モジュール**:
- `list_all_sheets(excel_path)`: すべてのシート名をリスト
- `generate_pdfs(excel_path, sheet_names, version, output_dir)`: PDFを生成

**主要機能**:
- xlwingsを使用してExcelのCOM APIにアクセス
- PageSetupを構成（横向き、FitToPagesWide=1）
- Excelの書式を保持してPDF化

### step2_ai_review.py
**AI評審モジュール**:
- `review_with_gemini(pdf_paths, prompt_template, api_key, model)`: Gemini APIを呼び出し
- `review_with_retry(...)`: リトライロジック付き（最大3回）

**主要機能**:
- PDFファイルをGemini APIにアップロード
- JSON modeとPydantic schemaを使用して構造化出力を強制
- `response.parsed`で自動的に`ReviewTable`オブジェクトを取得

### step3_save_results.py
**Excel結果保存モジュール**:
- `save_to_excel(review_table, round_number, output_dir)`: フォーマット済みExcelを生成

**主要機能**:
- openpyxlを使用してワークブックを作成
- スタイル適用:
  - ヘッダー行: 淡い青色背景（#ADD8E6）
  - 全セル: 罫線
  - AutoFilter有効化
  - 列幅の自動調整（最大50文字）

### main.py
**PySide6 GUIメインアプリケーション**:
- `ReviAIApp`: メインウィンドウ（QMainWindow）
- `Step1Page`, `Step2Page`, `Step3Page`: 各段階のウィジェット
- `AIReviewWorker`: バックグラウンドスレッド（UI凍結防止）
- `PromptEditorDialog`: プロンプト編集ダイアログ

**UIフロー**:
- QStackedWidgetを使用して3つのページを管理
- ページ間でデータを受け渡し（PDFパス、評審結果）
- エラーハンドリングとユーザーへのフィードバック

---

## 🔍 技術的な詳細

### Gemini API統合

**JSON Schema強制出力**:
```python
response = client.models.generate_content(
    model="gemini-2.5-pro",
    contents=[prompt, pdf_file],
    config={
        'response_mime_type': 'application/json',
        'response_schema': ReviewTable,  # Pydanticモデル
        'temperature': 0,  # 決定論的出力
    }
)

result: ReviewTable = response.parsed  # 自動解析！
```

**利点**:
- ✅ 手動JSON解析不要
- ✅ 自動データ検証
- ✅ 列の順序が保証される
- ✅ 日本語の完全サポート

### PDF処理

**xlwings PageSetup構成**:
```python
ws = wb.sheets[sheet_name]
ps = ws.api.PageSetup
ps.Orientation = xw.constants.PageOrientation.xlLandscape  # 横向き
ps.FitToPagesWide = 1      # 幅を1ページに収める
ps.FitToPagesTall = False  # 高さは自動改ページ
ws.to_pdf(output_path)
```

これにより、ExcelのネイティブPDF出力機能を使用し、書式が完全に保持されます。

### スレッド処理

**UIのフリーズを防ぐ**:
```python
class AIReviewWorker(QThread):
    finished = Signal(ReviewTable)
    error = Signal(str)

    def run(self):
        result = step2.review_with_gemini(...)
        self.finished.emit(result)
```

メインUIスレッドをブロックせずに、長時間実行されるAPI呼び出しを処理します。

---

## 💰 コスト見積もり

### Gemini 2.5 Pro価格

| 項目 | 価格 |
|-----|------|
| 入力トークン | $1.25 / 1M tokens (コンテキスト<200K) |
| 出力トークン | $10 / 1M tokens |

### 1文書あたりのコスト

**想定**:
- 10ページのPDF ≈ 2,580トークン
- 100行の表出力 ≈ 5,000トークン

**計算**:
- 入力: 2,580 × $1.25/1M = **$0.003**
- 出力: 5,000 × $10/1M = **$0.05**
- **合計: 約$0.053（5.3円/文書）**

### 無料枠

Gemini 2.5 Flashは**1日1,500リクエスト**の無料枠がありますが、Gemini 2.5 Proは制限付きです。本番運用には有料アカウントを推奨します。

---

## 🐛 トラブルシューティング

### 一般的な問題

#### 1. **「API keyが設定されていません」エラー**
**解決策**: `config.ini`を開いて、`gemini_api_key`に有効なAPI keyを設定してください。

#### 2. **「Excel file not found」エラー**
**解決策**: Microsoft Excelがインストールされていることを確認してください。xlwingsはExcelが必要です。

#### 3. **「Failed to parse API response」エラー**
**原因**: Gemini APIが構造化出力を返せなかった。
**解決策**:
- `prompt_template.txt`がわかりやすいか確認
- PDFが読み取り可能か確認（ぼやけていない、正しい向き）
- ログファイル（`logs/app.log`）で詳細を確認

#### 4. **GUI起動時のImportError**
**解決策**:
```bash
pip install --upgrade PySide6
```

#### 5. **日本語文字が文字化け**
**解決策**: Excelファイルと`prompt_template.txt`がUTF-8エンコーディングで保存されていることを確認してください。

---

## 📊 ログの確認

すべての操作は`logs/app.log`に記録されます:

```
[2025-01-27 14:30:45] [INFO] ReviAI application started
[2025-01-27 14:31:02] [INFO] Opening Excel file: プログラム基本設計書.xlsx
[2025-01-27 14:31:03] [INFO] Found 3 sheets: ['プログラム概要', '処理詳細', 'テスト計画']
[2025-01-27 14:31:10] [INFO] Starting PDF generation for 2 sheets
[2025-01-27 14:31:15] [INFO] Successfully generated: プログラム基本設計書_プログラム概要_V6.pdf
[2025-01-27 14:31:20] [INFO] PDF generation complete. Generated 2/2 files
[2025-01-27 14:32:00] [INFO] Starting AI review with 2 PDF files
[2025-01-27 14:32:05] [INFO] Uploading PDF: プログラム基本設計書_プログラム概要_V6.pdf
[2025-01-27 14:32:10] [INFO] Calling Gemini API for review...
[2025-01-27 14:33:45] [INFO] AI review completed successfully. Extracted 25 rows
[2025-01-27 14:34:00] [INFO] Creating Excel file: 第六回.xlsx
[2025-01-27 14:34:02] [INFO] Excel file saved successfully
```

---

## 🚀 今後の改善案

### MVP後の機能追加

1. **バッチ処理**
   - 複数バージョンを一度に処理
   - 自動バージョンインクリメント

2. **履歴管理**
   - 過去の評審結果を表示
   - バージョン間の比較レポート

3. **高度なエラー処理**
   - 自動リトライロジック
   - API制限の検出と待機

4. **エクスポートオプション**
   - PDF形式でレポート出力
   - CSV形式でデータエクスポート

5. **多言語対応**
   - 英語UI
   - 中国語UI

6. **クラウド統合**
   - Google Drive連携
   - SharePoint連携

---

## 📝 開発履歴

| 日付 | バージョン | 変更内容 |
|-----|----------|---------|
| 2025-01-27 | 1.0.0 | 初回リリース（MVP） |

---

## 👥 サポート

問題が発生した場合:
1. `logs/app.log`を確認
2. エラーメッセージをコピー
3. GitHub Issuesで報告するか、開発チームに連絡

---

## 📄 ライセンス

このプロジェクトはプロプライエタリソフトウェアです。無断複製・配布を禁じます。

---

## ✅ チェックリスト

デプロイ前の確認事項:

- [ ] Python 3.8以降がインストール済み
- [ ] Microsoft Excelがインストール済み
- [ ] すべての依存関係がインストール済み（`pip install -r requirements.txt`）
- [ ] `config.ini`にGemini API keyが設定済み
- [ ] `prompt_template.txt`が要件に合わせてカスタマイズ済み
- [ ] テストExcelファイルでPDF生成が成功
- [ ] テストPDFでAI評審が成功
- [ ] 評審結果のExcel保存が成功
- [ ] ログファイルが正常に記録される

---

**ReviAI - 文書評審の未来を自動化**
