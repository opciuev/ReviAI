
================================================================================
ドキュメント: プログラム基本設計書_プラグイン振分モジュール_解析加工IF定義_AI審査_六回目_V0.pdf (PDF 1)
ファイル名: プログラム基本設計書_プラグイン振分モジュール_解析加工IF定義_AI審査_六回目_V0.pdf
================================================================================

要求No 要求内容 (ペルソナ: 指令)

評価 (〇/△/×) 適合/不適合箇所 適合/不適合理由

修正案 (ゴールデンケースを含む)

対応有無 対応方法／非対応理由

SA-1

SystemArchitect: 論理トレーサ
ビリティの検証

△

SA-2

SystemArchitect: 機能要件と
非機能要件の分離と結合

△

全体

全体

モジュール内部の処理フロー（パラメータJSON受信→プラグインロード→
Before/Main/After実行）は記述されているが、このモジュールがどのビジネス要
件や上位のユースケースを実現するためのものか、トレーサビリティが不明確。
要件定義書との関連が記載されていないため、設計の妥当性を上位要件から検
証できない。

設計書の冒頭に「1.3 関連要件」などの節を設け、本モジュールが対応する要件定義書
の要求No（例：REQ-BIZ-005）を明記する。これにより、設計の目的とスコープが明確に
なる。

×

　関連要件 は共通仕様書にて一元管理されている。個
別のモジュール設計書で重複して定義することは、管理
の複雑化を招くため行わない。

「メモリコストを抑えるために、レコード単位で戻して」という記述があり性能への考
慮は見られるが、具体的な非機能要件（例：秒間N件の処理性能、プラグインロー
ドのタイムアウト値、異常発生時のリトライ回数など）が定義されておらず、それら
を実現するための設計（パラメータや制御ロジック）が欠落している。

非機能要件を定義し、それを満たすための設計を追記する。例えば、「3.4 非機能要件
への考慮」の節を追加し、タイムアウト処理について「プラグインの各メソッド（Before,
Main, After）の実行時間が300秒を超えた場合、タイムアウト例外をスローし、処理を中
断する」といった具体的な仕様を記述する。

×

　ご指摘の非機能要件（タイムアウト、リトライ）は、本モ
ジュールを呼び出す上位（累積工具）側の責務である。
本モジュールはタイムアウト等を自身では管理せず、上
位からの要求に従う。

QA-1

QAManager: 処理ロジックの具
体性評価 (WDT分析)

△

V6: 3 プラグイン側
の動作をさせて...

プラグインの実行順序が「Before → Main → After」と定義されているが、各ステッ
プで異常が発生した場合の制御フローが不明確。
例えば、Before処理でエラーが返却された場合に、MainやAfterが実行されるの
か、あるいは即座に処理を中断して終了するのかが記述されておらず、テスト担
当者が異常系の動作を想定できない。（V5には「前処理が正常完了の場合のみ、
本処理を実行する」とあるがV6では言及がない）

各処理ステップ間の遷移条件を明確にする。【ゴールデンケース】
状態遷移図やフローチャートを用いて、正常系と異常系の両方のパスを明記する。
例：
1. Before()を実行。失敗した場合、After()は実行せず、エラーとして終了。
2. Before()が成功した場合、Main()を実行。Main()で例外が発生した場合、After()を実行
してリソース解放等を行い、エラーとして終了。
3. Main()が成功した場合、After()を実行する。

×

　「Before→Main→After」の制御フロー は、本モジュール
が実装する IFileParserPlugin インターフェースの共通規
約である。インターフェースの規約（Beforeが失敗すれば
Main/Afterは実行されない）を、実装側の設計書に重複
して記述することは冗長であるため行わない。

QA-2

QAManager: 用語と定義の明
確化

×

V6とV5のAPI定義全
体

最新版(V6)と旧版(V5)でAPIのシグネチャに重大な不整合が見られる。V6の
`LoadAndRunPlugin`には`logUtil`引数があるがV5にはない。また、V6の`After`メ
ソッドは`out string jsonMessage`を持つが、V5の`After`は引数なしでExitCodeを
返す仕様になっている。どちらが正なのか不明であり、実装とテストに深刻な混乱
を招く。

API定義を正として一本化する。V6が最新であるならば、V5のドキュメントは破棄または
V6の内容に完全に追従させる。修正案：「IFileParserPlugin」インターフェースの定義を明
確にドキュメントに記載し、`LoadAndRunPlugin`メソッドのシグネチャと、プラグインが実
装すべき`Before`, `Main`, `After`の各メソッドのシグネチャ（引数、戻り値）を確定版とし
て1箇所に定義する。

×

　本レビューの対象はV6 の設計書（acumulate-file-
parser-dispatcher） である。V5 は過去のドキュメントであ
り、V6が唯一の正である。V5のドキュメントを破棄 するか
は別途管理の問題であり、本設計書の修正は不要であ
る。

QA-3

QAManager: 異常系の網羅性 △

全体

「何か異常がある場合」や「異常発生の場合」といった一般的な記述に留まってお
り、想定される具体的な異常ケースが網羅されていない。
例えば、「指定されたプラグインDLLが存在しない」「DLLは存在するが
IFileParserPluginインターフェースを実装したクラスが見つからない」「JSONパラ
メータの必須項目が欠落している」といった、起こりうる具体的なエラーケースと、
その際のシステムの振る舞い（ログ内容、返却するExitCodeやメッセージ）が定義
されていないため、異常系テストの設計が困難。

「5. 異常系処理」の章を設け、想定される異常ケースを一覧表で定義する。【ゴールデン
ケース】
表形式で「No.」「異常ケース」「検知箇所」「振る舞い（ログ出力内容、返却ExitCode、返
却メッセージ）」を記述する。
例：
No.1, 異常ケース: プラグインDLLファイルが見つからない, 検知箇所: 2.2 アセンブリロー
ド時, 振る舞い: ERRORログ「プラグイン'{dll名}'が見つかりません。」を出力。ExitCode=-
101を返却。

QA-4

QAManager: 処理ロジックの具
体性評価 (WDT分析) - 「Do」
の具体性

×

V6: 3.3 後処理
(After) の実行, 4.2
最終結果の返却

Afterメソッドの戻り値（out引数とExitCode）と、`LoadAndRunPlugin`メソッド自体の
戻り値の関係性が不明確。
「3.3の処理結果を累積ツールへ返却する」とあるが、具体的にどの値をどのように
マッピングして`LoadAndRunPlugin`の戻り値とするのかが記述されておらず、実装
者がロジックを推測する必要がある。

`LoadAndRunPlugin`の戻り値の生成ロジックを明確に記述する。【ゴールデンケース】
1. `After`メソッドから`ExitCode`と`jsonMessage`を取得する。
2. `LoadAndRunPlugin`は、戻り値オブジェクト（例：`PluginResult`クラス）を生成する。
3. `PluginResult.ExitCode`に`After`から受け取った`ExitCode`を設定する。
4. `PluginResult.Message`に`After`から受け取った`jsonMessage`を設定する。
5. この`PluginResult`オブジェクトを呼び出し元に返却する。
のように、値の受け渡しと加工のシーケンスを具体的に記述する。

　ご指摘の異常ケース は本モジュールの責務外である。

1. 「DLLが存在しない」：.NETランタイムがスローするシス
テムレベルの例外であり、本モジュールの上位（Host）が
ハンドリングする。

2. 「JSON必須項目欠落」：各プラグイン側のBeforeメソッ
ドが検証する責務を持つ。

　本モジュールの仕様は**「お客様の要求（式样）」に基
づき、Afterメソッド が返したExitCodeとjsonMessageをそ
のまま上位にパススルー（Pass-through）**することであ
る。AI審査員が提案するようなPluginResultオブジェクト
でラップする設計は、お客様の要求に反する。本文書
「4.2 振分モジュールは、上記3.3の処理結果を累積ツー
ルへ返却する」 に記載の通りであり、修正は不要。

×

×





================================================================================
ドキュメント: プログラム基本設計書_プラグイン_振分モジュール_処理詳細_V6.pdf (前回の設計書 V6)
ファイル名: プログラム基本設計書_プラグイン_振分モジュール_処理詳細_V6.pdf
================================================================================

3-1.処理詳細説明(全体)

システム名 f013カタログ部品データ作成
業務機能名 累積作成ツール

プログラムID

acumulate-file-parser-dispatcher プログラム名称 プラグイン_振分モジュール

システムID
バージョン
プロジェクトNo

作成日
更新日

2025/1/8
2025/10/30

12000599-00

区分

作成者
更新者

汎用

3H.尚坤
3H.尚坤

詳細内容

・振分モジュールの概要

本モジュール（以下「振分モジュール」）は、IFileParserPluginインターフェースを実装したプラグインを起動させるために、このモジュールを作成します。
起動時引数の表現を JSON に統一することで、可読性・保守性・拡張性を確保することを目的とする。

それで、各プラグインが利用情報は異なるが、引数を統一するために、関連の情報をJSON形式の文字列パラメータとして渡します。
pluginParamJsonは、各プラグインで必要なパラメータを一元的に管理・保持するために、JSON形式の文字列として構成されています。

それで、プラグイン側で処理対象レコードは大量にあるため、メモリコストを抑えるために、レコード単位で戻して、コールバックメソッドも追加します。

API定義:

LoadAndRunPlugin(string pluginParamJson, Action<DataRow> onDataRow LogUtil logUtil)

パラメータ :
名称
pluginParamJson
onDataRow
logUtil

※pluginParameter.jsonの構成:
ノード名
LineageGroupID
LineageSubGroupId
LineageId
LineageSummary
LineageReousceInfo
TransformYamlInfoDic
DataFileList
MacroVariable
WorkFlowSettings
EventFileContent
今後の拡張

説明
パラメータJSON文字列
レコード返却用のコールバック
LogUtilインスタンス

説明
リネージグループID
リネージサブグループID
リネージID
リネージ関連情報
リネージリソース情報
入力ファイル情報辞書
入力ファイルリスト
マクロ変数
ワークフロー設定情報
イベントファイル内容
...

詳細
プラグインの実行に必要な各種情報をJSON形式で格納した文字列データ
読み取ったレコードを1件ずつ呼び出し元へ返却するコールバックメソッド
モジュールにもログ出力できるために、 LogUtil インスタンスも引数として

詳細内容
データ処理のリネージグループID
このデータパイプラインの子ワークフローIDです
呼び出し元のリネージ定義 LineageId
リネージのプラグイン、プロセス名称などの設定情報
入出力リソースのエンコーディング、入出力区分、圧縮方式などの設定情報
入力ファイルのrepository、ファイル名称ルール、スキーマYaml名等設定情報
対象ファイルフルパスリスト
変数定義
ログ出力、GCSパス、作業・出力ディレクトリなど、ワークフロー実行に必要な設定
処理実行の契機となるイベント設定。ジョブ情報、通知先メールアドレス、通知API、などを含む。
...

JSON 形式の動的パラメータを保持する JObject（Newtonsoft.Jsonライブラリ）。

JObject jsonObj = new JObject
{
    ["LineageGroupID"] = JToken.FromObject(parameterInfo.LineageGroupInfo.LineageGroupID),
    ["LineageSubGroupId"] = JToken.FromObject(parameterInfo.LineageSubgroupInfo.LineageSubgroupID),
    ["LineageId"] = JToken.FromObject(parameterInfo.LineageGroupInfo.LineageSubgroupSummary.LineageSummaryList.First().LineageID),
    ["LineageSummary"] = JToken.FromObject(parameterInfo.LineageGroupInfo.LineageSubgroupSummary.LineageSummaryList.First()),
    ["LineageReousceInfo"] = JToken.FromObject(parameterInfo.LineageInfoList.First()),
    ["TransformYamlInfoDic"] = JToken.FromObject(transformInfo.InputFile),
    ["DataFileList"] = JToken.FromObject(new List<string> { "xxx" }),
    ["MacroVariable"] = JToken.FromObject(parameterInfo.MacroVariableList),
    ["WorkFlowSettings"] = JToken.FromObject(parameterInfo.SettingsInfo),
    ["EventFileContent"] = parameterInfo.EventInfo is null ? null : JToken.FromObject(parameterInfo.EventInfo)
};

戻り値:

解析結果ワークデータ（wkDataRow）

バラメータYamlファイルに指定したInputスキーマのデータレコードリストです。

・処理詳細

1 処理開始ログの出力

振分モジュールの処理開始時に、振分モジュール名を使用して、以下の形式でログを出力する：

メッセージ内容:

INFO タイプ： 「プラグイン振分モジュール」を開始します...

2　「指定プラグイン」をロードして

プロセスログ

PROCESS タイプ： プラグイン「{pluginDll}」 取得

2.1 パラメータ「JSON文字列」から、

「LineageSummary」の「ExtendFunctionInfo1」から、解析用のブラグインDLL名称を取得する

プロセスログ

PROCESS タイプ： プラグイン「{pluginDll}」のロード

2.2 取得したDLL名とクラス名（FileParsing）を基に、対象プラグインのアセンブリをロードする。

3 プラグイン側の動作をさせて、データレコード、実行結果を取得

本システムのプラグインは IFileParserPlugin を実装し、Before → Main → After の順で動作させます。
振分モジュールは本順序を厳守し、After は最後に 1 回実行させます。

3.1 前処理 (Before) の実行

実行前準備：パラメータ検証・環境/リソースの初期化

プラグイン側にて、初期処理、引数の解析、環境設定チェック、対象データファイルのチェック、ログ情報の出力などを実行させます。

プロセスログ

PROCESS タイプ： 振り分けモジュール : 前処理Before()メソッド呼出し

メソッド:名:

Before(string pluginParamJson,LogUtil logUtil)

パラメータ :

改訂No. 削

4
4
4
4

6
4
4
4
4
4
6
6

6
6
6
6

6
6

6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6

pluginParamJson
logUtil

パラメータJSON文字列
LogUtilインスタンス

プラグイン用のJSON形式パラメータ文字列
モジュールもログ出力するため引数として

3.2 本処理 (Main) の実行

入力データの読み出し・解析・レコード返却

プロセスログ

PPROCESS タイプ： 振り分けモジュール : 本処理Main()メソッド呼出し

メソッド名:

Main(Action<DataRow> onDataRow)

パラメータ :

onDataRow

解析結果レコードを逐次返却するコールバック

逐次返却には、処理済みのDataRowを受け取るデリゲート（コールバック）を使用します。

3.3 後処理 (After) の実行

プラグインのMain()処理ができたら、プラグインの実行結果情報を取得するために、このAfterメソッドを実行させます。

プロセスログ

PROCESS タイプ： 振り分けモジュール : 後処理After()メソッド呼出し

メソッド名:

After(out string jsonMessage)

パラメータ :

jsonMessgae

戻り値：

異常ありの場合、最後に発生したエラーのメッセージをJSON形式で返却する引数
→ 「DataLineageExecuteLog」の「detail_message」項目に出力する用です。

＞　正常終了の場合、 ExitCode=0
＞　異常発生の場合、最後に発生したエラーの ExitCode

4 処理終了情報の出力、最終結果の返却

4.1 振分モジュールの実行で、完了ログの出力:

正常完了の場合:

INFO タイプ： 「プラグイン振分モジュール」が完了しました。

上記の処理に、何か異常がある場合:

ERROR タイプ： 「プラグイン振分モジュール」が異常終了しました。

4.2 振分モジュールは、上記3.3の処理結果を累積ツールへ返却する

LoadAndRunPlugin()メソッドの戻り値として、
実行結果(ExitCode)、異常内容、結果メッセージ（JSON文字列）を戻します。

6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6

6
6
6
6
6
6
6
6
6
6
6





================================================================================
ドキュメント: プログラム基本設計書_プラグイン_振分モジュール_処理詳細_V7.pdf (今回の設計書 V7)
ファイル名: プログラム基本設計書_プラグイン_振分モジュール_処理詳細_V7.pdf
================================================================================

改訂No. 削

4
4
4
4

6
4
4
4
4
4
6
6

3-1.処理詳細説明(全体)

システム名 f013カタログ部品データ作成
業務機能名 累積作成ツール

プログラムID

acumulate-file-parser-dispatcher プログラム名称 プラグイン_振分モジュール

システムID
バージョン
プロジェクトNo

作成日
更新日

2025/1/8
2025/10/30

12000599-00

区分

作成者
更新者

汎用

3H.尚坤
3H.尚坤

詳細内容

・振分モジュールの概要

本モジュール（以下「振分モジュール」）は、IFileParserPluginインターフェースを実装したプラグインを起動させるために、このモジュールを作成します。
起動時引数の表現を JSON に統一することで、可読性・保守性・拡張性を確保することを目的とする。

それで、各プラグインが利用情報は異なるが、引数を統一するために、関連の情報をJSON形式の文字列パラメータとして渡します。
pluginParamJsonは、各プラグインで必要なパラメータを一元的に管理・保持するために、JSON形式の文字列として構成されています。

それで、プラグイン側で処理対象レコードは大量にあるため、メモリコストを抑えるために、レコード単位で戻して、コールバックメソッドも追加します。

API定義:

LoadAndRunPlugin(string pluginParamJson, Action<DataRow> onDataRow LogUtil logUtil)

パラメータ :
名称
pluginParamJson
onDataRow
logUtil

※pluginParameter.jsonの構成:
ノード名
LineageGroupID
LineageSubGroupId
LineageId
LineageSummary
LineageReousceInfo
TransformYamlInfoDic
DataFileList
MacroVariable
WorkFlowSettings
EventFileContent
今後の拡張

説明
パラメータJSON文字列
レコード返却用のコールバック
LogUtilインスタンス

説明
リネージグループID
リネージサブグループID
リネージID
リネージ関連情報
リネージリソース情報
入力ファイル情報辞書
入力ファイルリスト
マクロ変数
ワークフロー設定情報
イベントファイル内容
...

詳細
プラグインの実行に必要な各種情報をJSON形式で格納した文字列データ
読み取ったレコードを1件ずつ呼び出し元へ返却するコールバックメソッド
モジュールにもログ出力できるために、 LogUtil インスタンスも引数として

詳細内容
データ処理のリネージグループID
このデータパイプラインの子ワークフローIDです
呼び出し元のリネージ定義 LineageId
リネージのプラグイン、プロセス名称などの設定情報
入出力リソースのエンコーディング、入出力区分、圧縮方式などの設定情報
入力ファイルのrepository、ファイル名称ルール、スキーマYaml名等設定情報
対象ファイルフルパスリスト
変数定義
ログ出力、GCSパス、作業・出力ディレクトリなど、ワークフロー実行に必要な設定
処理実行の契機となるイベント設定。ジョブ情報、通知先メールアドレス、通知API、などを含む。
...

JSON 形式の動的パラメータを保持する JObject（Newtonsoft.Jsonライブラリ）。

JObject jsonObj = new JObject
{
    ["LineageGroupID"] = JToken.FromObject(parameterInfo.LineageGroupInfo.LineageGroupID),
    ["LineageSubGroupId"] = JToken.FromObject(parameterInfo.LineageSubgroupInfo.LineageSubgroupID),
    ["LineageId"] = JToken.FromObject(parameterInfo.LineageGroupInfo.LineageSubgroupSummary.LineageSummaryList.First().LineageID),
    ["LineageSummary"] = JToken.FromObject(parameterInfo.LineageGroupInfo.LineageSubgroupSummary.LineageSummaryList.First()),
    ["LineageReousceInfo"] = JToken.FromObject(parameterInfo.LineageInfoList.First()),
    ["TransformYamlInfoDic"] = JToken.FromObject(transformInfo.InputFile),
    ["DataFileList"] = JToken.FromObject(new List<string> { "xxx" }),
    ["MacroVariable"] = JToken.FromObject(parameterInfo.MacroVariableList),
    ["WorkFlowSettings"] = JToken.FromObject(parameterInfo.SettingsInfo),
    ["EventFileContent"] = parameterInfo.EventInfo is null ? null : JToken.FromObject(parameterInfo.EventInfo)
};

戻り値:

解析結果ワークデータ（wkDataRow）

バラメータYamlファイルに指定したInputスキーマのデータレコードリストです。

・時系列図

・処理詳細

1 処理開始ログの出力

振分モジュールの処理開始時に、振分モジュール名を使用して、以下の形式でログを出力する：

メッセージ内容:

INFO タイプ： 「プラグイン振分モジュール」を開始します...

2　「指定プラグイン」をロードして

プロセスログ

PROCESS タイプ： プラグイン「{pluginDll}」 取得

2.1 パラメータ「JSON文字列」から、

「LineageSummary」の「ExtendFunctionInfo1」から、解析用のブラグインDLL名称を取得する

プロセスログ

PROCESS タイプ： プラグイン「{pluginDll}」のロード

2.2 取得したDLL名とクラス名（FileParsing）を基に、対象プラグインのアセンブリをロードする。

3 プラグイン側の動作をさせて、データレコード、実行結果を取得

本システムのプラグインは IFileParserPlugin を実装し、Before → Main → After の順で動作させます。
振分モジュールは本順序を厳守し、After は最後に 1 回実行させます。

3.1 前処理 (Before) の実行

実行前準備：パラメータ検証・環境/リソースの初期化

プラグイン側にて、初期処理、引数の解析、環境設定チェック、対象データファイルのチェック、ログ情報の出力などを実行させます。

プロセスログ

PROCESS タイプ： 振り分けモジュール : 前処理Before()メソッド呼出し

メソッド:名:

Before(string pluginParamJson,LogUtil logUtil)

パラメータ :

pluginParamJson
logUtil

パラメータJSON文字列
LogUtilインスタンス

プラグイン用のJSON形式パラメータ文字列
モジュールもログ出力するため引数として

3.2 本処理 (Main) の実行

入力データの読み出し・解析・レコード返却

プロセスログ

PROCESS タイプ： 振り分けモジュール : 本処理Main()メソッド呼出し

メソッド名:

Main(Action<DataRow> onDataRow)

パラメータ :

onDataRow

解析結果レコードを逐次返却するコールバック

逐次返却には、処理済みのDataRowを受け取るデリゲート（コールバック）を使用します。

3.3 後処理 (After) の実行

プラグインのMain()処理ができたら、プラグインの実行結果情報を取得するために、このAfterメソッドを実行させます。

プロセスログ

PROCESS タイプ： 振り分けモジュール : 後処理After()メソッド呼出し

メソッド名:

After(out string jsonMessage)

パラメータ :

jsonMessgae

戻り値：

異常ありの場合、最後に発生したエラーのメッセージをJSON形式で返却する引数
→ 「DataLineageExecuteLog」の「detail_message」項目に出力する用です。

＞　正常完了の場合、 ExitCode=0
＞　異常発生の場合、最後に発生したエラーの ExitCode

4 処理終了情報の出力、最終結果の返却

4.1 振分モジュールの実行で、完了ログの出力:

ExitCode=0 :

INFO タイプ： 「プラグイン振分モジュール」が正常完了しました。

上記の処理に、何か異常がある場合:

ERROR タイプ： 「プラグイン振分モジュール」が異常終了しました。

4.2 振分モジュールは、上記3.3の処理結果を累積ツールへ返却する

LoadAndRunPlugin()メソッドの戻り値として、
実行結果(ExitCode)、異常内容、結果メッセージ（JSON文字列）を戻します。

上記の処理に、何か異常がある場合:

ERROR タイプ： 「プラグイン振分モジュール」が異常終了しました。
ERROR タイプ： {ex.Message}
ERROR タイプ： {ex.StackTrace}

6
6
6
6

6
6

6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6
6

6
6
6
6
6
6
6
6
6
6
6


