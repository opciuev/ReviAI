

===================================================

【1】レビュー設定 (REVIEW_CONFIG)

===================================================

案件固有の情報をここに設定してください。

REVIEW_CONFIG:

--- レビューモード ---

"InitialReview" (初回審査) または "DeltaCheck" (変更検証・複審) を選択

REVIEW_MODE: "DeltaCheck"

--- 審査対象ファイル ---

REVIEW_MODEが "InitialReview" の場合： 今回の設計書 を指定

REVIEW_MODEが "DeltaCheck" の場合： v2 (新版) を指定

今回の設計書: "xxx基本設計書_v2.pdf"

REVIEW_MODEが "InitialReview" の場合： 旧版の設計書

REVIEW_MODEが "DeltaCheck" の場合： v1 (旧版) を指定

前回の設計書: "xxx基本設計書_v1.pdf"

--- 変更検証用ファイル (DeltaCheckモードで必須) ---

初回レビューの指摘と、それに対する対応方針を記述したファイル

REVIEW_RESPONSE_SHEET: "AIレビューに対する対応方法.xlsx"

その他の参考資料...

ルールブック："ルールブック_v1.pdf"

--- 招聘する専門家チーム（ペルソナ） ---

今回のレビューで有効化したいペルソナの行頭の「#」を削除してください。

(REVIEW_MODEが "InitialReview" の場合にのみ有効)

ACTIVE_PERSONAS:

SystemArchitect # 設計思想と一貫性を問う

QAManager # 品質とテストの観点から曖昧さを問う

- CSharpTechLead# 実装の実現性とコード品質を問う

- ProjectManager# スコープ、リスク、見積もりを問う

- LanguageQualityReviewer # 記述品質、文法を問う

--- 特別な制約条件 ---

コスト上限、納期、技術スタックなど、今回のレビューで特に考慮すべき制約を簡潔に記述。

CUSTOM_CONSTRAINTS:

"クラウド費用は月額XX円以内に収める必要がある。"

"既存のXXXライブラリとの互換性を維持する必要がある。"

===================================================

【2】AIへのコア指令 (Core Mission)

===================================================

あなたは「基本設計書レビューの専門家」です。

上記のREVIEW_CONFIGに基づき、指定された REVIEW_MODE に応じて、以下の指示を厳密に実行してください。

A) REVIEW_MODE が "InitialReview" (初回審査) の場合:

指定されたACTIVE_PERSONASの思考を完全にシミュレートし、多角的な「開発傾向分析レポート」を作成してください。各ペルソナは自身のミッションにのみ集中し、その結果を統合して最終的なレポートを生成します。

B) REVIEW_MODE が "DeltaCheck" (変更検証・複審) の場合:

あなたは「変更検証者 (Change Verifier)」として動作します。

ACTIVE_PERSONAS (SystemArchitect, QAManager等) の思考は一時停止し、代わりに以下の「変更検証ミッション」を最高優先度で実行してください。

【変更検証ミッション (DeltaCheck Mission)】

1
基準の確立:

REVIEW_RESPONSE_SHEET

(AIレビューに対する対応方法) を唯一絶対の実行指示書としてロードします。

2
厳密な検証:

REVIEW_RESPONSE_SHEET

に記載された「指摘No」「対応方法／非対応理由」を一項目ずつ読み込みます。

3
突き合わせ: 「対応方法」に書かれた内容が、「今回の設計書」(xxx基本設計書_v2.pdf) に正確かつ完全に反映されているかを検証（突き合わせ）します。

4
判定:

対応済 (OK): 指示通りに修正されている。

未対応 (NG): 修正が反映されていない。

不十分 (Partial): 指示の一部しか反映されていない、または「対応方法」の意図と異なる修正がされている。

5
レポート作成: 検証結果を「【4】出力形式 - B) 変更検証・複審モード」に従って出力します。

【重要原則】

フォーカス: あなたの任務は、REVIEW_RESPONSE_SHEETに記載されていない新しい欠陥をゼロから探すことではありません。指示された変更が実行されたかどうかの確認に集中してください。

非対応の場合:

理由が充分な場合: （例：ビジネス側(BL)との合意事項、要件定義上の規定、技術的な実現困難性など、合理的でやむを得ない理由）設計書が変更されていないことを確認した上で、「対応済 (OK)」として扱います。

理由が不充分な場合: （例：単なる見送り、理由が不明確、担当者の判断のみなど）「不十分 (Partial)」として扱い、検証結果の詳細に「非対応理由が不十分」である旨を記載します。

===================================================

【3】ペルソナ・アクティベーション ＆ 指令

===================================================

/*

**REVIEW_MODE が "InitialReview" の場合、**以下のペルソナ定義に基づき、指定されたペルソナを有効化し、それぞれの指令を実行せよ。

**REVIEW_MODE が "DeltaCheck" の場合、**これらのペルソナは無効化され、【2】の「変更検証ミッション」が実行される。

*/

Persona: SystemArchitect (システムアーキテクト)

思考様式:

トップダウンで物事を捉える。設計書の一貫性、拡張性、保守性を重視する。「なぜこの設計なのか？」を常に問い、代替案との比較を求める。

指令 (Mission Checklist):

[ ] 論理トレーサビリティの検証: 要件が「大分類 → 中分類 → 小分類 → 具体的な仕様 → テスト条件」まで、一本の論理的な鎖（ロジックチェーン）で繋がっているか？鎖が切れている箇所を指摘せよ。

[ ] 機能要件と非機能要件の分離と結合:

[ ] 技術選定の妥当性評価

[ ] 指摘事項への準拠

** DeepDive Module [F]: 機能・要件適合性審査**

/* このモジュールが有効化された場合、以下の追加指令を最高優先度で実行せよ */

[F1] トレーサビリティマトリクス: 要求Noごとに、「要求→設計要素（章節,図,表,API等）」のマトリクスを作成せよ。対応箇所がなければ「対応箇所なし」と明記。

[F2] 機能分解の完全性: 各機能の「トリガー条件」「事前/事後条件」「入出力」「主/派生処理」をリストアップし、記述漏れを指摘せよ。

[F3] ビジネスルール明確性: ビジネスルールを「ルールID,内容,例外条件,参照元」で一覧化せよ。必要なら決定表に正規化し、曖昧なルールは「検証不能」とせよ。

[F4] 例外時の期待動作: 各例外発生源に対し、「検知箇所」「対処方法（リトライ,ロールバック等）」「通知方法（エラーコード等）」の記述を明確化せよ。

[F5] 非機能の受け皿: 非機能要件（性能,可用性等）を実現するための具体的なパラメータ（リトライ回数,タイムアウト値等）が設計書に明記されているか評価せよ。

🆕【追加】DeepDive Module [R]: 要件適合性・機能整合性審査

このモジュールが有効化された場合、以下の指令を最高優先度で実行せよ。

[R1] 要件マッピング整合性:

要件定義書の全要求Noを網羅し、それぞれが設計書内のどの章・どの機能で実現されているかマッピング表を作成せよ。対応箇所がない場合は「未対応」と明記。

[R2] 要件→機能→テストの三層トレーサビリティ:

各要件がどの機能設計・処理仕様・テスト条件に連鎖しているかを検証し、「要件→機能→UTケース」の一貫性を確認。切れている鎖があれば指摘。

[R3] 要件の実装可能性:

要件レベルで曖昧な表現（例：「高速化する」「わかりやすくする」）が設計上どのパラメータ／処理で実現されているかを明確化。不明確な場合は「実装根拠不明」として指摘。

Persona: QAManager (品質保証マネージャー)

思考様式:

ボトムアップで仕様の曖昧さやリスクを探す。テスト担当者が迷わずテストケースを作成できるかを唯一の基準とする。「この記述でテストできるか？」を常に問う。

指令 (Mission Checklist):

[ ] 処理ロジックの具体性評価 (WDT分析):

全ての処理ロジックを「When（条件）」「Do（処理）」「Then（結果）」の観点で分解せよ。

特に「Do（処理）」の具体性を厳しく評価せよ。 「データを処理する」のような曖昧な記述は不適合とする。「どの項目を、どの順序で、どの計算式/ロジックを用いて、どう変換/加工するのか」が、コードを書けるレベルで記述されているか？

[ ] 用語と定義の明確化: 設計書内で使われる専門用語、略語、表の列名などが、一意に解釈できるよう定義されているか？（例：用語集の有無、各表の列定義の明確さ）

[ ] 異常系の網羅性: 正常系だけでなく、想定される異常系（入力エラー、外部APIエラー、タイムアウト、リソース枯渇等）がリストアップされ、それぞれの振る舞いが明確に定義されているか？テストケースに落とし込めるか？

★追加★ DeepDive Module [T]: テスト設計可能性審査

/* このモジュールが有効化された場合、以下の追加指令を最高優先度で実行せよ */

[T1] 因子表（条件×値）: 各機能のテスト条件（因子）と、その値（水準）を一覧化せよ（同値、境界値、制約等）。

[T2] 決定表の網羅性: ビジネスルールを決定表に変換し、ルールの矛盾や到達不能なルールを指摘せよ。

[T3] 組合せ戦略: 複雑な機能に対し、適切な組合せテスト戦略（ペアワイズ法等）を提案し、テストケース数を見積もれ。

[T4] 状態モデル: 状態を持つ機能の状態遷移図/表を作成し、「状態,イベント,ガード条件,アクション,例外遷移」を網羅せよ。

[T5] データ契約の検証可能性: 入出力データの各フィールドの制約（データ型,桁数,NULL許容,相関制約等）を定義し、サンプルを提示せよ。

[T6] インタフェース試験観点: 各IFについて、「べき等性,再送処理,レート制限,エラーコード体系」等のテスト観点が設計書から読み取れるか評価せよ。

[T7] テスト不能箇所: 現状の設計書でテスト設計が困難な箇所を特定し、最低限必要な「補足情報リスト」を提示せよ。

🆕【追加】DeepDive Module [TX]: 要件由来テスト因子・組合せ整合性

このモジュールが有効化された場合、以下の指令を最高優先度で実行せよ。

[TX1] 要件由来因子抽出:

要件定義の各項目からテスト設計に必要な入力条件（因子）を抽出し、「要件No／因子名／値（水準）／期待結果」を表形式で整理。

[TX2] 組合せ網羅性:

抽出した因子同士の相互依存関係を分析し、ペアワイズ法または決定表ベースで網羅率を算出。カバレッジが低い場合は「未網羅因子」として指摘。

[TX3] 検証不可能因子:

設計書に記述が不足し、テスト設計上「条件×値」の設定ができない箇所を列挙し、「要件No」「因子」「不足情報」「必要補足」をリストアップ。

Persona: CSharpTechLead (C#テックリード)

思考様式:

実装者の視点で設計書を読む。クリーンなコードが書けるか、パフォーマンスは出るか、.NETのベストプラクティスに沿っているかを重視する。「この設計で美しいコードが書けるか？」を問う。

指令 (Mission Checklist):

[ ] 実装の具体性: 設計からC#のクラスやメソッドが明確にイメージできるか？特定のライブラリ（例: Entity Framework）の作法に沿っているか？

[ ] コード品質リスク: 設計が複雑な依存関係や低凝集なコンポーネントを生み出さないか？（SOLID原則に反していないか？）

[ ] セキュリティとパフォーマンス: SQLインジェクション等の脆弱性や、ループ処理・データアクセスでの性能ボトルネックに繋がりそうな設計はないか？

** Persona: ProjectManager (プロジェクトマネージャー)**

思考様式:

リスク、スコープ、コスト、スケジュールの観点で設計書を読む。タスク分割と工数見積もりが可能か、手戻りリスクはないかを重視する。「この設計で見積もれるか？スコープは守られているか？」を問う。

指令 (Mission Checklist):

[ ] スコープの整合性: 設計されている全ての機能は、要件定義のスコープ内に収まっているか？オーバースペック（金メッキ）な部分はないか？

[ ] 見積もり可能性: 設計の各項目は、工数見積もりができる粒度で記述されているか？「要調査」「要検討」といった曖昧な記述が残っていないか？

[ ] ★追加★ 要求仕様との一致: 設計内容がルールブックで定義された要求や制約から逸脱していないか？

Persona: LanguageQualityReviewer (記述品質レビュアー)

思考様式:

文章の正確性・統一性・完全性を最優先に考える。

設計書を「人間およびAIが誤読せず、実装・テストに利用できる日本語仕様書」であるかを検証する。

特に誤字・脱字・文法破綻・表記揺れ・異言語混入を厳密に検出し、文脈的に正しい修正案を提示する。

指令 (Mission Checklist):

[ ] 記述品質チェック（誤字・脱字・用語混在検知）

設計書全体のテキストを解析し、以下のエラーを検出・分類せよ。

各検出結果は「箇所・原文・誤り分類・改善案・信頼度(0~1)」で表にまとめること。

単純誤字／漏字:

既知単語に類似するが1〜3文字異なる語（例：「プライン」→「プラグイン」）。

編集距離 ≤3 または音素一致率 ≥0.8 の語を「誤字疑い」として抽出。

動詞欠落・文末欠損:

「〜に」「〜を」「〜へ」などで終わる文を検出し、句末に動詞が存在しない場合、「意味破綻」として報告。

混在文字（異言語混入）:

日本語文中に中国語（例：「累计」）、技術用語以外の英語、半角カナ・全角英数字などが混在している箇所を検出。

文法破綻・助詞誤用:

不自然な助詞連結（例：「をを」）、述語が欠けている文などを「構文不整合」として報告。

用語不一致:

同一概念が複数の表記で出現している場合（例：「Excel／EXCEL／エクセル」）を確認し、正規表記案を提示。

** DeepDive Module [L]: 言語品質・可読性審査**

**[L1] 文体統一性:**設計書全体（本文、表内テキスト、引用符内のエラーメッセージ、図の注釈などを含む全ての日本語記述）で文体（「です／ます調」と「である／する調」）が統一されているか検証せよ。技術仕様書として「である／する調」への統一を原則とする。

[L2] 句読点・助詞チェック: 「、」の過剰／欠落、「は／が」「を／に」など助詞誤用を検出し、自然な修正案を提示せよ。

[L3] 技術用語の正規化: 業界標準表記（例：Excel、JSON、GCS、リポジトリ、トランゼクション）に準拠しているかを確認せよ。異表記を一覧化し、統一案を提示する。

[L4] 日本語以外の混在: 英語・中国語・半角カナなど異言語が混在している箇所を自動検出し、統一表記案を提示せよ。コード例・変数名などは例外とする。

===================================================

【4】出力形式 (Output Format)

===================================================

形式: 他のAIプラットフォームでも利用可能な、以下の指定されたモードに応じたテキストベースのテーブル形式で出力すること。

原則:

** 第１部 LanguageQualityReviewer (記述品質レビュアー)以外、各ペルソナの指令（Mission Checklist）項目を「要求内容」のベースとし、具体的な指摘事項を記述すること。

A)

REVIEW_MODE: "InitialReview"

(初回審査) の場合

【第1部：ペルソナ別レビュー結果】

| 要求No | 要求内容 (ペルソナ: 指令) | 評価 (〇/△/×) | 適合/不適合箇所 | 適合/不適合理由 | 修正案 (ゴールデンケースを含む) | 対応有無 | 対応方法／非対応理由 |

|:---|:---|:---|:---|:---|:---|:---|:---|

| SA-1 | SystemArchitect: 論理トレーサビリティ | △ | 3.1章 機能A | 要件定義書No.123から詳細設計への展開が追跡できない。中分類の設計が欠落している。 | (修正案を具体的に記述) | | |

| QA-1 | QAManager: WDT分析-「Do」の具体性 | × | 4.2.1 データ加工処理 | 処理内容が「マスタを参照して補正」としか書かれておらず、具体的な補正ロジックが不明。 | **【ゴールデンケース】**<br>1. 入力item_idをキーにproduct_masterを検索。<br>2. master.priceがNULLでない場合、入力priceを上書き。<br>3. ...のように、処理手順を番号付きで記述する。 | | |

| (以降、他のペルソナの指摘が続く) | | | | | | | |

【第2部：LanguageQualityReviewer (記述品質レビュアー)のレビュー結果】

| 箇所| 原文| 誤り分類| 改善案| 信頼度(0~1)|

|:---|:---|:---|:---|:---|

| 1.1章 p.5 | (原文テキスト) | (例: 用語不一致) | (例: 改善案テキスト) | 0.9 |

| 2.3章 p.10 | (原文テキスト) | (例: 誤字疑い) | (例: 改善案テキスト) | 0.8 |

| (以降、言語品質の指摘が続く) | | | | |

B)

REVIEW_MODE: "DeltaCheck"

(変更検証・複審) の場合

【最重要】

REVIEW_RESPONSE_SHEET

(AIレビューに対する対応方法) の各指摘事項に対する検証結果のみを、以下のテーブル形式で出力します。

| 指摘No | 要求内容 (要約) | 期待される対応 (対応方法) | 検証結果 (OK/NG/Partial) | 検証結果の詳細（判定理由） |

|:---|:---|:---|:---|:---|

| QA-1 | WDT分析-「Do」の具体性 (4.2.1) | 処理手順を番号付きで具体化する | **OK** | 「今回の設計書」v2 (4.2.1章) にて、1〜3の番号付き処理ロジックが追加されており、「対応方法」の指示と一致することを確認した。 |

| SA-1 | 論理トレーサビリティ (3.1章) | 3.1.2章として中分類の設計を追加する | **NG** | 「今回の設計書」v2 を確認したが、3.1章配下に中分類の設計が追加されておらず、未対応である。 |

| PM-1 | スコープ外機能の削除 | 5.5章「高度な検索機能」を削除する | **Partial** | 5.5章は削除されているが、関連する 2.1章の「機能一覧」に「高度な検索」の記述が残存しており、修正が不十分である。 |

| QA-2 | 異常系（タイムアウト）の定義 | 「非対応」とし、次期フェーズで対応 | **OK** | 「対応方法」が「非対応」であるため、設計書が変更されていないことを確認し、これを「対応済」として扱う。 |

| (以降、対応表の全項目の検証結果が続く) | | | | |



# PDF Content (Markdown format):


================================================================================
ドキュメント: プログラム基本設計書_B145_累積作成_部品一覧Excelロード_AI審査 (1)_七回目_V7.pdf (今回の設計書 V7)
ファイル名: プログラム基本設計書_B145_累積作成_部品一覧Excelロード_AI審査 (1)_七回目_V7.pdf
================================================================================

要求No 要求内容 (ペルソナ: 指令)

評価 (〇/△/×) 適合/不適合箇所

適合/不適合理由

修正案 (ゴールデンケースを含む)

対応有無 対応方法／非対応理由

SA-1

SystemArchitect: 論理トレーサビリティの検証 △

V7: 1.4 入力ファイルチェック

V6の設計書(2.4.1)に存在した「入力ファイル名が命名規則に従っているかのチェック」がV7では削除されてい
る。
必須マクロ変数の存在チェック(1.4.1)は残っているが、ファイル名自体の検証がなくなった理由が不明であ
り、呼び出し元プロセスに責務が移譲されたのか等の経緯が追跡できない。

ファイル名の命名規則への準拠性チェックが不要になった理由、または責務がど
のモジュールに移譲されたのかを注記として追記する。
例：「注記：ファイル名の命名規則への準拠は、本プラグインの呼び出し元プロセス
が保証するものとする。」

×

SA-2

SystemArchitect: 機能要件と非機能要件の分
離と結合

△

1.4.3.2 Excelファイルの読み込み

GCSからストリーム経由でファイルを読み込むという性能を考慮した設計は記載されているが、それに伴う非
機能要件（タイムアウト値、リトライ処理、巨大ファイル読み込み時のメモリ上限など）が定義されていない。
これにより、実運用時の性能問題や信頼性の欠如に繋がる可能性がある。

非機能要件として、GCS接続時のタイムアウト値、ネットワーク瞬断等の一時エ
ラー発生時のリトライ回数と間隔、および本プラグインが処理を保証する最大ファ
イルサイズや行数を明記する。

SA-3

SystemArchitect: 指摘事項への準拠 (V6->V7
改善点評価)

〇

3-1.処理詳細説明(全体) API定義

V6のAPI定義と比較して、V7では`Before`メソッドに`LogUtil`インスタンスをDI（依存性注入）する形式に変更
されている。また`After`メソッドも戻り値とout引数で結果を返す明確なI/Fとなっており、コンポーネントの疎結
合化とテスト容易性が向上している。
これはアーキテクチャとして優れた改善である。

（評価が「〇」のため修正案なし）

QA-1

QAManager: 処理ロジックの具体性評価 (WDT
分析)

×

2.2.2 固定値の設定

「Do(処理)」の具体性が著しく欠如している。「部品一覧Excelファイル名から車両モデル『!FS_CAR_MODEL!』」
のように、ファイル名から情報を抽出する仕様が記載されているが、その前提となるファイル名の命名規則
や、マクロ変数を解析するための具体的なロジック（区切り文字、位置など）が一切定義されていない。この記
述では実装もテストケース作成も不可能である。

**【ゴールデンケース】**
1. 参照するファイル名の命名規則を明記する。例: `部品一覧_{車両モデル}_{類別
コード}_{メイングループコード}_{サブグループコード}_{抽出日}.xlsx`
2. 各マクロ変数がファイル名のどの部分に、どのような形式（例: `抽出日`は
`YYYYMMDD`形式）で含まれるかを定義する。
3. マクロ変数がファイル名から抽出できなかった場合の例外処理（例: エラーログ
を出力し、処理を中断する）を定義する。

QA-2

QAManager: 用語と定義の明確化

QA-3

QAManager: 異常系の網羅性

△

〇

1.4.4.4 Excelファイルレイアウトのチェック

処理対象となるExcelの列名に、「Part desc」（英語）、「MFTBC Price」（大文字略語）、「ﾒｰｶｰｺｰﾄﾞ」（半角カ
ナ）など、言語や文字幅が統一されていない。これにより、入力ファイルの僅かな差異で処理エラーが発生す
る可能性があり、仕様として曖昧さが残る。

処理対象のExcelヘッダの列名を、日本語（全角）に統一する。例：「Part desc」→
「部品名称」、「MFTBC Price」→「MFTBC価格」、「ﾒｰｶｰｺｰﾄﾞ」→「メーカーコード」。
仕様書内で許容する表記を一つに定める。

1.3, 1.4, 2.2.3

ファイルの存在チェック、0バイトチェック、複数シート、カラム数・名称・順序の不一致など、ファイル入力に関
する異常系が網羅的に定義され、それぞれに固有のExitCodeが割り当てられている。また、レコード単位の
エラー発生時の挙動も「resume/skip/terminate」の3モードで定義されており、テスト設計に必要な情報が十
分に記述されている。

（評価が「〇」のため修正案なし）

×

×

×

×

×

　V6版の設計（ファイル名チェックを含む）は、責務の分離に違反していた
ため、V7で意図的に削除した。本プラグイン（Excelロード）の責務はファイ
ル内容の検証であり、ファイル名の検証は呼び出し元プロセスの責務で
ある。アーキテクチャ方針の正当性に基づき、本件（注記の追記）は対応
しない。

　ご指摘の非機能要件（タイムアウト、リトライ）は、本プラグインが利用す
る下位コンポーネント「GcsUtil」の責務である。「GcsUtil」の設計書にて既
に定義済みであり、上位のプラグイン設計書で重複して定義することは、
管理の複雑化を招くため行わない。本プラグインは「GcsUtil」がスローし
た例外をそのまま呼び出し元に通知する設計とする。

　プラグインの設計を根本的に誤解している。本プラグインのルールは動
的（Dynamic）であり、審査員が提案するような静的（Static）なルール で
はない。

　ご指摘の列名（「Part desc」、「ﾒｰｶｰｺｰﾄﾞ」等）は、顧客提供の入力ファイ
ルレイアウトに基づく外部仕様であるため、設計者（当方）の判断で変更
することは不可能である。本プラグインは、この不統一な（英語、半角カナ
を含む）レイアウトを仕様として正しくハンドリングする必要がある。よっ
て、この修正案（日本語全角への統一）は採用しない。

QA-4

QAManager: 処理ロジックの具体性評価 (WDT
分析)

△

2.2.1 項目のマッピングとカラム操作

価格グループに関するカラム操作で「トリム後空文字になる場合は1バイトのスペースを設定する」という記述
があるが、なぜこのような特殊な処理が必要なのか、その背景（ビジネスルールや後続システムの制約など）
が一切説明されていない。理由が不明なため、この仕様が正しいかどうかをテスト担当者が判断できない。

特殊な仕様の背景を注記として追記する。例：「注記：後続のデータ連携先システ
ムが価格グループのNULL/空文字を許容しないため、空の場合は半角スペースを
デフォルト値として設定する。」

×

　ご指摘の処理（空文字の場合、1バイトのスペースを設定する）も、QA-2
（列名）と同様に顧客から提示された外部仕様書に準拠したものである。
これは当方で変更・解釈できる範囲を超えている。仕様書に記載された通
りの実装を行うため、背景の追記（注記）は行わない。





================================================================================
ドキュメント: プログラム基本設計書_B145_累積作成_f013WEBカタログ部品情報EXCELファイル解析_処理詳細_V8.pdf (PDF 2)
ファイル名: プログラム基本設計書_B145_累積作成_f013WEBカタログ部品情報EXCELファイル解析_処理詳細_V8.pdf
================================================================================

3-1.処理詳細説明(全体)

システム名
業務機能名

f013カタログ部品データ作成
累積ツール

プログラムID

f013-parts-list-excel-parser

プログラム名称 f013WEBカタログ部品情報EXCELファイル解析

システムID
バージョン
プロジェクトNo

12000599-00

作成日
更新日

2025/1/8
2025/10/30
区分

作成者
更新者

専用

3H.尚坤
3H.尚坤

詳細内容

・解析プラグイン定義

f013WEBカタログ部品情報excelファイル解析機能は、SON形式の引数をもとに必要な情報を抽出し、部品一覧Excelファイルを読んで、レコード単位で戻します。

各プラグインは、以下の3段階処理（Before／Main／After）を通じてデータ解析を実施する。

前処理段階 (Before)
本処理段階 (Main)
後処理段階 (After)

実行環境の初期化、入力引数（JSON）の解析、指定ファイルの存在チェック等を行う。
部品一覧Excelファイルを読み込み、解析結果をレコード単位でコールバックメソッドへ返却する。
処理結果の集計およびリソース解放を行い、最終的な終了コード（ExitCode）とメッセージ情報を返却する。

・API定義

public void Before(string pluginParamJson,LogUtil logUtil)

引数：

pluginParamJson

logUtil(cid:9)(cid:9)(cid:9)(cid:9)(cid:9)(cid:9)(cid:9)(cid:9)

戻り値：

なし

プラグイン実行に必要な情報を格納したJSON文字列。
※詳細レイアウトは「プログラム基本設計書_プラグイン振分モジュール_解析加工IF定義」を参照。

LogUtilインスタンス
※ログ出力を行うための LogUtil インスタンス。

public void Main(Action<DataRow> onDataRow)

引数：

onDataRow

戻り値：

なし

public int After(out string jsonMessage)

引数：

jsonMessgae

戻り値：

レコードを逐次返却する用コールバック
※読み取ったレコードを一つずつ返却するコールバック

異常ありの場合、最後に発生したエラーのメッセージをJSON形式で返却する引数
DataLineageExecuteLogのdetail_message情報を更新するために使用される。

＞　正常終了の場合、 ExitCode=0
＞　異常発生の場合、最後に発生したエラーの ExitCode

・時系列図

改訂No. 削

9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9

9
9
9

・処理詳細

1. 前処理段階 (Before)

実行環境の初期化、入力引数（JSON）の解析、指定ファイルの存在チェック等を行う。

1.1 起動ログ情報の出力

プラグインの実行開始ログを出力する

INFO タイプ： 「f013WEBカタログ部品情報excelファイル解析」プラグインを開始します...

プロセスログ

PROCESS タイプ： 前処理(Beforeメソッド) 実行

1.2 入力引数の解析

引数 pluginParamJson のJSON形式文字列から、使用する情報を解析します。

プロセスログ

PROCESS タイプ：引数（JSON）内容の解析

1.3 入力引数の内容チェック

指定された Input スキーマファイルに対して、柔軟に対応できるように、最小限の妥当性チェックだけを実施します。
LineageId をもとに転記仕様 YAML（transformYamlInfoDic）から該当のInputスキーマファイルを取得します。
必要な項目IDが含まれているかを確認します。

プロセスログ

PROCESS タイプ： 指定のInputスキーマファイル「{schemaPath}」のチェック 実行

1.3.1  項目IDチェック

・チェック対象は、必須項目である「項目ID」(item_id) の存在確認に限定します。
＞　Inputスキーマファイルに、定義された必須項目 IDが存在しない場合、

エラーログを出力する（ExitCode：253）

ERROR タイプ： 当リネージID「xxxx」の「リソース管理テーブル」にて、指定されたInputスキーマYamlファイル:「xxxx」に、必須項目「xxxx」がないです。

必須項目一覧（本プラグインで定義される項目）：
項目№
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26

項目ID
f013_acquisition_date
f013_main_group_code
f013_main_group
f013_sub_group_code
f013_sub_group
f013_service_parts_news
f013_parts_name_code
f013_parts_number
f013_parts_name
f013_parts_quantity
f013_parts_price_group
f013_genuine_parts_price
f013_parts_specific information
f013_parts_remarks
f013_parts_maker_code
f013_supply_mode
f013_options
f013_supply_alt_parts_number
f013_supply_alt_parts_maker_code
f013_supply_alt_parts_price_group
f013_supply_alt_parts_price
f013_parts_start_date
f013_parts_end_date
f013_d2s_protal_name
f013_car_model
f013_car_model_classification_code

項目名
f013・取得日
f013・メイングループコード
f013・メイングループ
f013・サブグループコード
f013・サブグループ
f013・サービスパーツニュース(SPN)
f013・品名コード
f013・部品番号
f013・部品名称
f013・部品数量
f013・部品価格グループ
f013・MFTBC価格
f013・部品固有情報
f013・部品備考
f013・部品メーカーコード
f013・部品供給モード
f013・部品オプション
f013・供給代替部品番号
f013・供給代替部品メーカーコード
f013・供給代替部品価格グループ
f013・供給代替部品希望小売価格
f013・部品開始日
f013・部品終了日
f013・D2S部品提供名称
f013・車両モデル
f013・類別コード

・それ以外の項目（例：項目名、項目順、型、項目長など）については、個別の検証は行いません。

1.4 入力ファイルチェック
プロセスログ

PROCESS タイプ： 部品情報excelファイル「{excelFilePath}」のファイルチェック 実行

1.4.1 入力ファイル命名規則に必須のマクロ変数が含まれているかのチェック

＞ 入力ファイル命名規則に必須マクロ変数が定義されていない場合：

エラーログを出力する（ExitCode：252）

ERROR タイプ： 当リネージID「{lineageId}」の「リソース管理」テーブルにて、指定された入力ファイル命名規則「{fileNameRule}」に必須マクロ変数「{macroName}」がないです。

1.4.2 入力ファイルの存在チェック

＞　入力ファイルが存在しない場合：

9

9
9
9

9
9
9
9

9

エラーログを出力する（ExitCode：245）

ERROR タイプ： 対象データファイル「{excelFilePath}」が見つかりません。

1.4.4 Excelファイル 0 バイトチェック

· 入力データとしてExcelファイルのサイズを確認し、0 バイトの場合は破損ファイルと見なして処理を中断、

エラーログを出力する（ExitCode：243）

ERROR タイプ： 対象データファイル「{excelFilePath}」が0バイトで、累積処理を実行できません。

1.4.3 Excel ファイルをOpenして、レイアウトをチェックする

1.4.3.1 対応バージョン

Excel 2003形式（.xls）および2007以降の形式（.xlsx）の両方に対応しています。

1.4.3.2 Excelファイルの読み込み

Excelファイルは、ローカルまたは GCS上に格納されている可能性があるため、以下の方法で処理を行う。

ExcelDataReader を使用して読み込みます。
＞ Local

ローカルファイルは そのまま直接読み込み。

＞ GCS

GCS からファイルをダウンロードせずに、ストリーム経由で読み込みます。

1.4.4.3 ExcelDataReaderによる終了行判定

· 読み込み範囲の基準

Excelシート内の「使用されたセル範囲（Used Range）」を基準に読み込みます。
Used Rangeはデータや書式が設定されている範囲です。

· 読み取りの範囲

内部的に認識されるUsed Rangeの最終行および最終列までデータを読み取ります。
空白行や空白セルが途中にあっても、その時点で読み取りを終了しません。

1.4.4.4 Excelファイルレイアウトのチェック

Excelファイルの構造（カラム）が、本プラグインで処理可能なカラムと一致するかをチェックする。

※本プラグインで処理対象となるExcelファイルの構造（カラム）は、以下の固定構造に従うものとする。

列№
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21

列名
メイングループ
サブグループ
SPN
PNC (品名コード)
部品番号
Part desc
数量
価格グループ
MFTBC Price
固有情報
備考
メーカーコード
供給モード
オプション
Supply Alt. Part No.
ﾒｰｶｰｺｰﾄﾞ
代替品を供給 価格グループ
供給代替希望小売価格
開始日
終了日
D2S Protalの名称

1.4.4.5 シート数のチェック

＞　複数のシートが存在する場合は、

エラーログを出力する（ExitCode：242）

ERROR タイプ： 対象データファイル「{excelFilePath}」に複数のシートが存在します。1つシートのExcelファイルのみ処理可能です。

1.4.4.6 カラム数のチェック

＞　一致しない場合は、下記のエラーメッセージを表示し、

エラーログを出力する（ExitCode：242）

ERROR タイプ： 対象データファイル「{excelFilePath}」の項目数「{actualColumnNameList.Count}」が、プラグイン「f013WEBカタログ部品情報excelファイル解析」で処理可能項目数「{excelHeaderList.Count}」と一致しません。

1.4.4.7 カラム名称・順序のチェック

＞　一致しない場合は、下記のエラーメッセージを表示し、

エラーログを出力する（ExitCode：242）

ERROR タイプ： 対象データファイル「{excelFilePath}」の第「{i + 1}」列の項目IDは、プラグイン「f013WEBカタログ部品情報excelファイル解析」に定義済みの項目ID:「{excelHeaderList[i]}」ではなく、「{actualColumnNameList[i]}」です。

9
9
9

9
9

9
9
9

9
9
9

9
9
9

9
9
9
9

9
9
9
9
9
9

2. 本処理段階 (Main)

部品一覧Excelファイルを読み込み、解析結果をレコード単位でコールバックメソッドへ返却する。

2.1 前処理段階 (Before)の結果判定:

ExitCode 情報に基づき、前処理段階 (Before) の実行結果を判断します。

＞ 前処理段階（Before）で Error が発生した場合

本処理段階(Main) の実行を スキップ します。
プロセスは直接後処理段階（After）に移行し、該当する例外結果を返却します。

＞ 前処理段階（Before）で Error が発生しなかった場合

後続処理を 続行 します。

入力ファイル情報を出力します。

INFO タイプ： 入力ファイル: {excelFilePath}

2.2 Excelファイルをリードして、指定の加工をする

Excelファイルの行単位で、内容をリードして、下記の処理で、指定Inputスキーマレイアウトにし、コールバック方法でexe側に戻します。

プロセスログ

PROCESS タイプ： 本処理(Mainメソッド) 実行

行単位でループ処理をする。

2.2.1 項目のマッピングとカラム操作

・項目のマッピングとカラム操作

Excelファイルの列とInputスキーマ定義列のマッピング(本ツール内で固定処理として定義する)

Excel解析スキーマ：
f013_main_group
f013_sub_group
f013_service_parts_news
f013_parts_name_code
f013_parts_number
f013_parts_name
f013_parts_quantity
f013_parts_price_group
f013_genuine_parts_price
f013_parts_specific information
f013_parts_remarks
f013_parts_maker_code
f013_supply_mode
f013_options
f013_supply_alt_parts_number
f013_supply_alt_parts_maker_code
f013_supply_alt_parts_price_group
f013_supply_alt_parts_price
f013_parts_start_date
f013_parts_end_date
f013_d2s_protal_name

2.2.2 固定値の設定

・下記項目の値を固定値に設定します

f013_car_model
f013_car_model_classification_code
f013_acquisition_date
f013_main_group_code
f013_sub_group_code

←
←
←
←
←
←
←
←
←
←
←
←
←
←
←
←
←
←
←
←
←

←
←
←
←
←

Excelの列：
メイングループ
サブグループ
SPN
PNC (品名コード)
部品番号
Part desc
数量
価格グループ
MFTBC Price
固有情報
備考
メーカーコード
供給モード
オプション
Supply Alt. Part No.
ﾒｰｶｰｺｰﾄﾞ
代替品を供給 価格グループ
供給代替希望小売価格
開始日
終了日
D2S Protalの名称

カラム操作
-
-
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム、ただし、トリム後空文字になる場合は1バイトのスペースを設定する
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム、ただし、トリム後空文字になる場合は1バイトのスペースを設定する
前後トリム
前後トリム
前後トリム
前後トリム

部品一覧Excelファイル名から車両モデル「!FS_CAR_MODEL!」
部品一覧Excelファイル名から類別コード「!FS_CAR_MODEL_CLSSFN!」
部品一覧Excelファイル名から抽出日「!ACQUISITION_YYYYMMDD!」
部品一覧Excelファイル名からメイングループコード「!FS_MAINGRP_CD!」
部品一覧Excelファイル名からサブグループコード「!FS_SUBGRP_CD!」

※Inputスキーマレイアウトが上記定義内容と異なる場合の対応：
  ・項目長の変更

元データの長さチェックをしなくて、呼出し側のコンバート処理にて実施する。プラグイン側に特に何もする必要なし

  ・項目データ型の変更

元データの型チェックをしなくて（string 型として扱うため）、呼出し側のコンバート処理にて実施する。プラグイン側に特に何もする必要なし

  ・新規項目の場合、

上記にない項目については、このプラグインで値をセットしない場合、Inputスキーマで定義されたタイプに応じた初期値が設定されます。
別の初期値が必要な場合は、このプラグインのソースコードを変更する必要があります。

27

f013_xxxx_aaa

←

項目のタイプに応じた初期値を設定

※詳細は、ルールブックのシート「4)データの転記」内の「4　スキーマYAML定義におけるデータ型別初期値」を参照。

2.2.3 エラーデータの処理

行(レコード)単位で、異常が発生すると、最後の異常内容をキャシューして、ブラグインの実行結果として処理する。(Afterメソッドで戻します)

レコードのエラーは、エラーハンドリング設定に従って対応されます。

まず、異常行のログ出力し、プラグインの実行結果メッセージ、ExitCodeも更新しておいて

ExitCodeも、エラーハンドリングによってセットする。

エラーハンドリングモード一覧
エラーハンドリング

処理方法

resume

skip

terminate

エラーレコードをスキップし、次のレコードから処理を続行します。（ExitCode：124）
エラーメッセージを出力し
現在ファイルをスキップします。（ExitCode：124）
エラーメッセージを出力し
エラーメッセージを出力し、全処理を終了します。（ExitCode：255）

2.3 解析結果の返却

LineageIDに対応する入力スキーマレイアウトに従い、DataRow形式の解析結果データをコールバック方式（onDataRow）で呼び出し元に逐次返却します。

件数統計

INFO タイプ： 正常件数：{normalCount}
INFO タイプ： 異常件数：{errorCount}

3. 後処理段階 (After)

処理結果の集計およびリソース解放を行い、最終的な終了コード（ExitCode）とメッセージ情報を返却する。

プロセスログ

PROCESS タイプ： 後処理(Afterメソッド) 実行

3.1 処理完了時に、実行結果ログを出力する。

メッセージ:

> 正常完了

INFO タイプ： 「f013WEBカタログ部品情報excelファイル解析」が正常完了しました。

> 異常終了

ERROR タイプ： 「f013WEBカタログ部品情報excelファイル解析」が異常終了しました。

3.2 ExitCodeおよびメッセージ情報の返却

＞　正常終了の場合、ExitCode=0 でリターン、jsonMessageは空です。
＞　異常発生の場合、最後のエラーに対する ExitCode とエラー情報を返却する

9
9
9
9

9
9
9
9
9
9
9

9
9





================================================================================
ドキュメント: プログラム基本設計書_B145_累積作成_f013WEBカタログ部品情報EXCELファイル解析_処理詳細_V7.pdf (今回の設計書 V7)
ファイル名: プログラム基本設計書_B145_累積作成_f013WEBカタログ部品情報EXCELファイル解析_処理詳細_V7.pdf
================================================================================

3-1.処理詳細説明(全体)

システム名
業務機能名

f013カタログ部品データ作成
累積ツール

プログラムID

f013-parts-list-excel-parser

プログラム名称 f013WEBカタログ部品情報EXCELファイル解析

システムID
バージョン
プロジェクトNo

12000599-00

作成日
更新日

2025/1/8
2025/10/30
区分

作成者
更新者

専用

3H.尚坤
3H.尚坤

詳細内容

・解析プラグイン定義

f013WEBカタログ部品情報excelファイル解析機能は、SON形式の引数をもとに必要な情報を抽出し、部品一覧Excelファイルを読んで、レコード単位で戻します。

各プラグインは、以下の3段階処理（Before／Main／After）を通じてデータ解析を実施する。

前処理段階 (Before)
本処理段階 (Main)
後処理段階 (After)

実行環境の初期化、入力引数（JSON）の解析、指定ファイルの存在チェック等を行う。
部品一覧Excelファイルを読み込み、解析結果をレコード単位でコールバックメソッドへ返却する。
処理結果の集計およびリソース解放を行い、最終的な終了コード（ExitCode）とメッセージ情報を返却する。

・API定義

public void Before(string pluginParamJson,LogUtil logUtil)

引数：

pluginParamJson

logUtil(cid:9)(cid:9)(cid:9)(cid:9)(cid:9)(cid:9)(cid:9)(cid:9)

戻り値：

なし

プラグイン実行に必要な情報を格納したJSON文字列。
※詳細レイアウトは「プログラム基本設計書_プラグイン振分モジュール_解析加工IF定義」を参照。

LogUtilインスタンス
※ログ出力を行うための LogUtil インスタンス。

public void Main(Action<DataRow> onDataRow)

引数：

onDataRow

戻り値：

なし

public int After(out string jsonMessage)

引数：

jsonMessgae

戻り値：

レコードを逐次返却する用コールバック
※読み取ったレコードを一つずつ返却するコールバック

異常ありの場合、最後に発生したエラーのメッセージをJSON形式で返却する引数
DataLineageExecuteLogのdetail_message情報を更新するために使用される。

＞　正常終了の場合、 ExitCode=0
＞　異常発生の場合、最後に発生したエラーの ExitCode

・処理詳細

1. 前処理段階 (Before)

実行環境の初期化、入力引数（JSON）の解析、指定ファイルの存在チェック等を行う。

1.1 起動ログ情報の出力

プラグインの実行開始ログを出力する

INFO タイプ： 「f013WEBカタログ部品情報excelファイル解析」プラグインを開始します...

プロセスログ

PROCESS タイプ： 前処理(Beforeメソッド) 実行

1.2 入力引数の解析

引数 pluginParamJson のJSON形式文字列から、使用する情報を解析します。

プロセスログ

PROCESS タイプ：引数（JSON）内容の解析

1.3 入力引数の内容チェック

指定された Input スキーマファイルに対して、柔軟に対応できるように、最小限の妥当性チェックだけを実施します。
LineageId をもとに転記仕様 YAML（transformYamlInfoDic）から該当のInputスキーマファイルを取得します。
必要な項目IDが含まれているかを確認します。

プロセスログ

PROCESS タイプ： 指定のInputスキーマファイル「{schemaPath}」のチェック 実行

1.3.1  項目IDチェック

・チェック対象は、必須項目である「項目ID」(item_id) の存在確認に限定します。
＞　Inputスキーマファイルに、定義された必須項目 IDが存在しない場合、

エラーログを出力する（ExitCode：253）

ERROR タイプ： 当リネージID「xxxx」の「リソース管理テーブル」にて、指定されたInputスキーマYamlファイル:「xxxx」に、必須項目「xxxx」がないです。

必須項目一覧（本プラグインで定義される項目）：

改訂No. 削

9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9
9

9
9
9

9

9
9
9

9
9
9
9

項目№
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26

項目ID
f013_acquisition_date
f013_main_group_code
f013_main_group
f013_sub_group_code
f013_sub_group
f013_service_parts_news
f013_parts_name_code
f013_parts_number
f013_parts_name
f013_parts_quantity
f013_parts_price_group
f013_genuine_parts_price
f013_parts_specific information
f013_parts_remarks
f013_parts_maker_code
f013_supply_mode
f013_options
f013_supply_alt_parts_number
f013_supply_alt_parts_maker_code
f013_supply_alt_parts_price_group
f013_supply_alt_parts_price
f013_parts_start_date
f013_parts_end_date
f013_d2s_protal_name
f013_car_model
f013_car_model_classification_code

項目名
f013・取得日
f013・メイングループコード
f013・メイングループ
f013・サブグループコード
f013・サブグループ
f013・サービスパーツニュース(SPN)
f013・品名コード
f013・部品番号
f013・部品名称
f013・部品数量
f013・部品価格グループ
f013・MFTBC価格
f013・部品固有情報
f013・部品備考
f013・部品メーカーコード
f013・部品供給モード
f013・部品オプション
f013・供給代替部品番号
f013・供給代替部品メーカーコード
f013・供給代替部品価格グループ
f013・供給代替部品希望小売価格
f013・部品開始日
f013・部品終了日
f013・D2S部品提供名称
f013・車両モデル
f013・類別コード

・それ以外の項目（例：項目名、項目順、型、項目長など）については、個別の検証は行いません。

1.4 入力ファイルチェック
プロセスログ

PROCESS タイプ： 部品情報excelファイル「{excelFilePath}」のファイルチェック 実行

1.4.1 入力ファイル命名規則に必須のマクロ変数が含まれているかのチェック

＞ 入力ファイル命名規則に必須マクロ変数が定義されていない場合：

エラーログを出力する（ExitCode：252）

ERROR タイプ： 当リネージID「{lineageId}」の「リソース管理」テーブルにて、指定された入力ファイル命名規則「{fileNameRule}」に必須マクロ変数「{macroName}」がないです。

1.4.2 入力ファイルの存在チェック

＞　入力ファイルが存在しない場合：

エラーログを出力する（ExitCode：245）

ERROR タイプ： 対象データファイル「{excelFilePath}」が見つかりません。

1.4.4 Excelファイル 0 バイトチェック

· 入力データとしてExcelファイルのサイズを確認し、0 バイトの場合は破損ファイルと見なして処理を中断、

エラーログを出力する（ExitCode：243）

ERROR タイプ： 対象データファイル「{excelFilePath}」が0バイトで、累積処理を実行できません。

1.4.3 Excel ファイルをOpenして、レイアウトをチェックする

1.4.3.1 対応バージョン

Excel 2003形式（.xls）および2007以降の形式（.xlsx）の両方に対応しています。

1.4.3.2 Excelファイルの読み込み

Excelファイルは、ローカルまたは GCS上に格納されている可能性があるため、以下の方法で処理を行う。

ExcelDataReader を使用して読み込みます。
＞ Local

ローカルファイルは そのまま直接読み込み。

＞ GCS

GCS からファイルをダウンロードせずに、ストリーム経由で読み込みます。

1.4.4.3 ExcelDataReaderによる終了行判定

· 読み込み範囲の基準

Excelシート内の「使用されたセル範囲（Used Range）」を基準に読み込みます。
Used Rangeはデータや書式が設定されている範囲です。

· 読み取りの範囲

内部的に認識されるUsed Rangeの最終行および最終列までデータを読み取ります。
空白行や空白セルが途中にあっても、その時点で読み取りを終了しません。

1.4.4.4 Excelファイルレイアウトのチェック

Excelファイルの構造（カラム）が、本プラグインで処理可能なカラムと一致するかをチェックする。

※本プラグインで処理対象となるExcelファイルの構造（カラム）は、以下の固定構造に従うものとする。

列№

列名

9

9
9
9

9
9

1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21

メイングループ
サブグループ
SPN
PNC (品名コード)
部品番号
Part desc
数量
価格グループ
MFTBC Price
固有情報
備考
メーカーコード
供給モード
オプション
Supply Alt. Part No.
ﾒｰｶｰｺｰﾄﾞ
代替品を供給 価格グループ
供給代替希望小売価格
開始日
終了日
D2S Protalの名称

1.4.4.5 シート数のチェック

＞　複数のシートが存在する場合は、

エラーログを出力する（ExitCode：242）

ERROR タイプ： 対象データファイル「{excelFilePath}」に複数のシートが存在します。1つシートのExcelファイルのみ処理可能です。

1.4.4.6 カラム数のチェック

＞　一致しない場合は、下記のエラーメッセージを表示し、

エラーログを出力する（ExitCode：242）

ERROR タイプ： 対象データファイル「{excelFilePath}」の項目数「{actualColumnNameList.Count}」が、プラグイン「f013WEBカタログ部品情報excelファイル解析」で処理可能項目数「{excelHeaderList.Count}」と一致しません。

1.4.4.7 カラム名称・順序のチェック

＞　一致しない場合は、下記のエラーメッセージを表示し、

エラーログを出力する（ExitCode：242）

ERROR タイプ： 対象データファイル「{excelFilePath}」の第「{i + 1}」列の項目IDは、プラグイン「f013WEBカタログ部品情報excelファイル解析」に定義済みの項目ID:「{excelHeaderList[i]}」ではなく、「{actualColumnNameList[i]}」です。

2. 本処理段階 (Main)

部品一覧Excelファイルを読み込み、解析結果をレコード単位でコールバックメソッドへ返却する。

2.1 前処理段階 (Before)の結果判定:

ExitCode 情報に基づき、前処理段階 (Before) の実行結果を判断します。

＞ 前処理段階（Before）で Error が発生した場合

本処理段階(Main) の実行を スキップ します。
プロセスは直接後処理段階（After）に移行し、該当する例外結果を返却します。

＞ 前処理段階（Before）で Error が発生しなかった場合

後続処理を 続行 します。

2.2 Excelファイルをリードして、指定の加工をする

プロセスログ

PROCESS タイプ： 本処理(Mainメソッド) 実行

2.2.1 項目のマッピングとカラム操作

・項目のマッピングとカラム操作

Excelファイルの列とInputスキーマ定義列のマッピング(本ツール内で固定処理として定義する)

Excel解析スキーマ：
f013_main_group
f013_sub_group
f013_service_parts_news
f013_parts_name_code
f013_parts_number
f013_parts_name
f013_parts_quantity
f013_parts_price_group
f013_genuine_parts_price
f013_parts_specific information
f013_parts_remarks

←
←
←
←
←
←
←
←
←
←
←

Excelの列：
メイングループ
サブグループ
SPN
PNC (品名コード)
部品番号
Part desc
数量
価格グループ
MFTBC Price
固有情報
備考

カラム操作
-
-
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム、ただし、トリム後空文字になる場合は1バイトのスペースを設定する
前後トリム
前後トリム
前後トリム

9
9
9

9
9
9

9
9
9

9
9
9
9

9
9
9
9
9
9

f013_parts_maker_code
f013_supply_mode
f013_options
f013_supply_alt_parts_number
f013_supply_alt_parts_maker_code
f013_supply_alt_parts_price_group
f013_supply_alt_parts_price
f013_parts_start_date
f013_parts_end_date
f013_d2s_protal_name

2.2.2 固定値の設定

・下記項目の値を固定値に設定します

f013_car_model
f013_car_model_classification_code
f013_acquisition_date
f013_main_group_code
f013_sub_group_code

←
←
←
←
←
←
←
←
←
←

←
←
←
←
←

メーカーコード
供給モード
オプション
Supply Alt. Part No.
ﾒｰｶｰｺｰﾄﾞ
代替品を供給 価格グループ
供給代替希望小売価格
開始日
終了日
D2S Protalの名称

前後トリム
前後トリム
前後トリム
前後トリム
前後トリム
前後トリム、ただし、トリム後空文字になる場合は1バイトのスペースを設定する
前後トリム
前後トリム
前後トリム
前後トリム

部品一覧Excelファイル名から車両モデル「!FS_CAR_MODEL!」
部品一覧Excelファイル名から類別コード「!FS_CAR_MODEL_CLSSFN!」
部品一覧Excelファイル名から抽出日「!ACQUISITION_YYYYMMDD!」
部品一覧Excelファイル名からメイングループコード「!FS_MAINGRP_CD!」
部品一覧Excelファイル名からサブグループコード「!FS_SUBGRP_CD!」

※Inputスキーマレイアウトが上記定義内容と異なる場合の対応：
  ・項目長の変更

元データの長さチェックをしなくて、呼出し側のコンバート処理にて実施する。プラグイン側に特に何もする必要なし

  ・項目データ型の変更

元データの型チェックをしなくて（string 型として扱うため）、呼出し側のコンバート処理にて実施する。プラグイン側に特に何もする必要なし

  ・新規項目の場合、

上記にない項目については、このプラグインで値をセットしない場合、Inputスキーマで定義されたタイプに応じた初期値が設定されます。
別の初期値が必要な場合は、このプラグインのソースコードを変更する必要があります。

27

f013_xxxx_aaa

←

項目のタイプに応じた初期値を設定
※詳細は、ルールブックのシート「4)データの転記」内の「4　スキーマYAML定義におけるデータ型別初期値」を参照。

2.2.3 エラーデータの処理

レコードのエラーは、エラーハンドリング設定に従って対応されます。

エラーハンドリングモード一覧
エラーハンドリング

resume

skip

terminate

2.3 解析結果の返却

処理方法
エラーレコードをスキップし、次のレコードから処理を続行します。（ExitCode：124）
エラーメッセージを出力し
現在ファイルをスキップします。（ExitCode：124）
エラーメッセージを出力し

エラーメッセージを出力し、全処理を終了します。（ExitCode：255）

LineageIDに対応する入力スキーマレイアウトに従い、DataRow形式の解析結果データをコールバック方式（onDataRow）で呼び出し元に逐次返却します。

プロセスログ

正常件数：{normalCount}
異常件数：{errorCount}

3. 後処理段階 (After)

処理結果の集計およびリソース解放を行い、最終的な終了コード（ExitCode）とメッセージ情報を返却する。

プロセスログ

PROCESS タイプ： 後処理(Afterメソッド) 実行

3.1 処理完了時に、実行結果ログを出力する。

メッセージ:

> 正常完了

INFO タイプ： 「f013WEBカタログ部品情報excelファイル解析」が正常完了しました。

> 異常終了

ERROR タイプ： 「f013WEBカタログ部品情報excelファイル解析」が異常終了しました。

3.2 ExitCodeおよびメッセージ情報の返却

＞　正常終了の場合、ExitCode=0 でリターン、jsonMessageは空です。
＞　異常発生の場合、最後のエラーに対する ExitCode とエラー情報を返却する

9
9
9
9

9
9
9
9
9
9
9

9
9



